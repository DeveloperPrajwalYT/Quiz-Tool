<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Master Toolkit (B&W Fixed)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --primary-color: #FFFFFF;
            --bg-light: #000000;
            --box-bg: #333333;
            --crossed-bg: #450a0a;
            --crossed-color: #ef4444;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--primary-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 7rem; /* Ensure space for the fixed nav */
        }

        /* --- HARDCODED CSS FOR RELIABILITY (Guaranteed Layout) --- */
        
        .custom-grid-container {
            display: grid;
            gap: 10px;
            width: 100%;
            padding: 10px;
            background-color: #1A1A1A; 
            border: 2px solid white;
            border-radius: 12px;
            min-height: 200px;
        }

        /* Grid Layouts - GUARANTEED COLUMN COUNT */
        .layout-12 { grid-template-columns: repeat(3, 1fr); }
        .layout-20 { grid-template-columns: repeat(4, 1fr); }
        .layout-30 { grid-template-columns: repeat(5, 1fr); }
        
        /* Responsive Overrides for Larger Screens (sm: 640px) */
        @media (min-width: 640px) {
            .layout-12 { grid-template-columns: repeat(4, 1fr); }
            .layout-20 { grid-template-columns: repeat(5, 1fr); }
            .layout-30 { grid-template-columns: repeat(6, 1fr); }
        }

        /* Number Box Styling - Touch Optimized */
        .custom-number-box {
            background-color: var(--box-bg); 
            color: white;
            border: 1px solid #777;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem; /* Base size */
            font-weight: bold;
            aspect-ratio: 1 / 1;
            cursor: pointer;
            transition: background-color 0.2s;
            user-select: none;
        }
        
        /* Scale up number text for larger screens (PC/Smart Board) */
        @media (min-width: 768px) {
             .custom-number-box {
                font-size: 2.2rem;
            }
        }

        .custom-number-box:hover {
            background-color: #555555;
        }

        /* Crossed Styling */
        .custom-number-box.crossed {
            background-color: var(--crossed-bg) !important;
            color: var(--crossed-color) !important;
            border-color: var(--crossed-color) !important;
            position: relative;
            pointer-events: none;
        }

        .custom-number-box.crossed::before {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                linear-gradient(to top right, transparent 48%, var(--crossed-color) 49%, var(--crossed-color) 51%, transparent 52%), 
                linear-gradient(to top left, transparent 48%, var(--crossed-color) 49%, var(--crossed-color) 51%, transparent 52%);
        }

        /* --- NAV & MODAL UTILS (B&W Theme) --- */
        .nav-item.active {
            background-color: #333;
            color: white;
            border-top: 2px solid white;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            z-index: 999;
        }
        .button-primary {
            background-color: white;
            color: black;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 8px;
            transition: transform 0.1s;
        }
        .button-primary:active { transform: scale(0.95); }
    </style>
</head>
<body class="p-4">

    <!-- Header -->
    <header class="mb-6 text-center">
        <!-- Title scales up on larger screens -->
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold">Quiz Control Panel</h1>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-4xl mx-auto">
        
        <!-- Timer Mode -->
        <div id="timer-mode" class="mode-content hidden">
            <div class="flex flex-col items-center justify-center h-64 border-2 border-white rounded-xl bg-white">
                <!-- Timer display scales aggressively for large screens/smart boards -->
                <div id="stopwatch-display" class="text-6xl sm:text-8xl lg:text-9xl font-mono mb-6 text-black">00:00:00</div>
                <div class="flex gap-4">
                    <button onclick="startStopwatch()" id="start-btn" class="button-primary">Start</button>
                    <button onclick="stopStopwatch()" id="stop-btn" class="button-primary opacity-50" disabled>Stop</button>
                    <button onclick="resetStopwatch()" class="button-primary bg-gray-300">Reset</button>
                </div>
            </div>
        </div>

        <!-- Selection Mode -->
        <div id="selection-mode" class="mode-content hidden">
            <h2 class="text-xl font-bold mb-4 text-center">Selection Round</h2>
            
            <!-- THE GRID CONTAINER -->
            <div id="grid-container" class="custom-grid-container">
                <p class="text-center text-gray-500 col-span-full py-10">
                    No grid selected. <br> Use Global Reset to select a new size.
                </p>
            </div>
        </div>

        <!-- Reset Mode -->
        <div id="reset-mode" class="mode-content hidden">
            <div class="flex flex-col items-center p-8 border-2 border-white rounded-xl bg-black">
                <h2 class="text-2xl font-bold text-red-500 mb-4">Global System Reset</h2>
                <p class="text-center text-gray-400 mb-6">This clears ALL data and lets you pick a new grid size.</p>
                <button onclick="showGlobalResetModal()" class="button-primary bg-red-600 text-white hover:bg-red-700">RESET EVERYTHING</button>
            </div>
        </div>

    </main>

    <!-- Nav Bar (Fixed at bottom) - Height adjusted for better touch targets -->
    <nav class="fixed bottom-0 left-0 w-full bg-black border-t border-white h-20 sm:h-24 flex justify-around items-center z-50">
        <button id="nav-timer" onclick="setMode('timer')" class="nav-item active flex-1 h-full flex flex-col items-center justify-center text-gray-500">
            <span class="text-2xl">‚è±Ô∏è</span>
            <span class="text-xs">Timer</span>
        </button>
        <button id="nav-selection" onclick="setMode('selection')" class="nav-item flex-1 h-full flex flex-col items-center justify-center text-gray-500">
            <span class="text-2xl">üî¢</span>
            <span class="text-xs">Selection</span>
        </button>
        <button id="nav-reset" onclick="setMode('reset')" class="nav-item flex-1 h-full flex flex-col items-center justify-center text-gray-500">
            <span class="text-2xl">‚ö†Ô∏è</span>
            <span class="text-xs">Reset</span>
        </button>
    </nav>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-black border-2 border-white p-6 rounded-lg w-11/12 max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Title</h3>
            <div id="modal-body" class="mb-6 flex flex-col gap-3"></div>
            <div id="modal-footer" class="flex justify-end gap-2"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Set log level to see Firebase logs in console
        setLogLevel('Debug');

        // CONFIG
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' && __firebase_config !== '' ? __firebase_config : '{"projectId": "test"}');
        
        let db, auth, userId;
        let gridSize = 0;
        let crossedNumbers = {};

        // SETUP
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, (user) => {
                if(user) {
                    userId = user.uid;
                    listenToData();
                } else {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if(token) signInWithCustomToken(auth, token);
                    else signInAnonymously(auth);
                }
            });
        } catch(e) { console.error(e); }

        function listenToData() {
            if (!userId) return;
            onSnapshot(doc(db, `artifacts/${appId}/users/${userId}/quiz_data`, 'state'), (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    const prevSize = gridSize;
                    gridSize = data.gridSize || 0;
                    crossedNumbers = data.crossedNumbers || {};
                    
                    renderGrid();

                    // Auto-show modal if size is 0 and we are in selection mode
                    if(gridSize === 0 && currentMode === 'selection' && prevSize !== 0) {
                        showSizeSelector();
                    }
                } else {
                    gridSize = 0;
                    crossedNumbers = {};
                    renderGrid();
                }
            }, (error) => {
                console.error("Firestore listen error:", error);
            });
        }

        window.saveState = async () => {
            if(!userId) return;
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/quiz_data`, 'state'), {
                    gridSize, crossedNumbers, timestamp: Date.now()
                });
            } catch (e) {
                console.error("Error saving state:", e);
            }
        }

        // LOGIC
        let currentMode = 'timer';

        window.setMode = (mode) => {
            currentMode = mode;
            document.querySelectorAll('.mode-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${mode}-mode`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${mode}`).classList.add('active');

            if(mode === 'selection' && gridSize === 0) {
                showSizeSelector();
            } else if (mode === 'selection' && gridSize !== 0) {
                renderGrid();
            }
        };

        window.renderGrid = () => {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            
            container.classList.remove('layout-12', 'layout-20', 'layout-30'); 

            if(gridSize === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 col-span-full py-10">Select a grid size via Reset.</p>';
                return;
            }

            container.classList.add(`layout-${gridSize}`);

            for(let i=1; i<=gridSize; i++) {
                const btn = document.createElement('div');
                btn.innerText = i;
                
                const isCrossed = crossedNumbers[i];
                btn.className = 'custom-number-box ' + (isCrossed ? 'crossed' : '');
                
                if(!isCrossed) {
                    btn.onclick = () => {
                        // 1. Immediate Visual Update
                        btn.classList.add('crossed'); 
                        btn.onclick = null; // Disable further clicks
                        
                        // 2. Data State Update
                        crossedNumbers[i] = true;
                        
                        // 3. Save to Firestore
                        saveState(); 
                    };
                }
                container.appendChild(btn);
            }
        };

        window.selectGridSize = (size) => {
            hideModal();
            gridSize = size;
            crossedNumbers = {};
            saveState();
            renderGrid(); 
            setMode('selection');
        };

        window.showSizeSelector = () => {
            if(gridSize !== 0) return;
            const html = `
                <button onclick="selectGridSize(12)" class="button-primary w-full bg-white text-black border border-white">Grid 1-12</button>
                <button onclick="selectGridSize(20)" class="button-primary w-full bg-white text-black border border-white">Grid 1-20</button>
                <button onclick="selectGridSize(30)" class="button-primary w-full bg-white text-black border border-white">Grid 1-30</button>
            `;
            showModal("Select Grid Size", html);
        };

        window.globalReset = async () => {
            gridSize = 0;
            crossedNumbers = {};
            await saveState();
            hideModal();
            setMode('timer');
            
            // Success modal with close button
            setTimeout(() => {
                const footerHtml = `<button onclick="hideModal()" class="button-primary bg-white text-black">Close</button>`;
                showModal("Success!", "Data cleared. Go to the **Selection** tab to choose a new grid size.", footerHtml);
            }, 200);
        };

        // Modal Helpers
        window.showGlobalResetModal = () => {
            showModal("CONFIRM GLOBAL RESET", 
                `<p class="text-red-500">Are you sure? This will permanently clear all Selection Grid data.</p>`,
                `<button onclick="globalReset()" class="button-primary bg-red-600 text-white">Yes, Reset</button>
                 <button onclick="hideModal()" class="text-gray-400 p-2">Cancel</button>`
            );
        };

        window.showModal = (title, body, footer='') => {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = body;
            document.getElementById('modal-footer').innerHTML = footer;
            document.getElementById('modal-overlay').classList.remove('hidden');
        };

        window.hideModal = () => document.getElementById('modal-overlay').classList.add('hidden');

        // Timer Logic
        let timerInterval, startTime = 0, elapsedTime = 0, running = false;
        
        function updateDisplay() {
            const ms = elapsedTime;
            const ss = Math.floor(ms/1000) % 60;
            const mm = Math.floor(ms/60000) % 60;
            const hh = Math.floor(ms/3600000);
            document.getElementById('stopwatch-display').innerText = 
                `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
        }

        window.startStopwatch = () => {
            if(running) return;
            running = true;
            startTime = Date.now() - elapsedTime;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').classList.add('opacity-50');
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('stop-btn').classList.remove('opacity-50');
            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                updateDisplay();
            }, 100);
        };

        window.stopStopwatch = () => {
            running = false;
            clearInterval(timerInterval);
            document.getElementById('start-btn').disabled = false;
            document.getElementById('start-btn').classList.remove('opacity-50');
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('stop-btn').classList.add('opacity-50');
        };

        window.resetStopwatch = () => {
            stopStopwatch();
            elapsedTime = 0;
            updateDisplay();
        };

        // Init
        setMode('timer');

    </script>
</body>
</html>

